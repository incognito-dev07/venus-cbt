<!DOCTYPE html>
<html>
<head>
  <title>Venus CBT - Messages</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/core.css">
  <link rel="stylesheet" href="/css/component.css">
  <link rel="stylesheet" href="/css/pages.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <script src="/js/config.js"></script>
  <script src="/js/api.js"></script>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div id="messagesContainer"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const selectedUser = urlParams.get('user');
    const searchQuery = urlParams.get('search') || '';
    
    let currentUserId = null;
    let messagesRefreshInterval = null;
    
    async function loadMessages() {
      try {
        const params = {};
        if (selectedUser) params.user = selectedUser;
        if (searchQuery) params.search = searchQuery;
        
        const data = await api.get(API_ENDPOINTS.messages, params);
        
        if (data.view === 'conversation') {
          renderConversation(data);
          startMessageRefresh();
        } else if (data.view === 'search') {
          renderSearchResults(data);
        } else {
          renderMessageList(data);
        }
        
      } catch (error) {
        document.getElementById('messagesContainer').innerHTML = `
          <div class="container">
            <div class="messages-panel">
              <div class="empty-state">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading messages: ${error.message}</p>
              </div>
            </div>
          </div>
        `;
      }
    }
    
    function renderMessageList(data) {
      const hasFriends = data.friends && data.friends.length > 0;
      const hasConversations = data.conversations && data.conversations.length > 0;
      
      let friendsHtml = '';
      let conversationsHtml = '';
      
      if (hasFriends) {
        friendsHtml = `
          <div class="section">
            <div class="section-header">
              <h3><i class="fas fa-user-friends"></i> Friends</h3>
              <span class="section-count">${data.friends.length}</span>
            </div>
            <div class="horizontal-scroll">
              ${data.friends.map(friend => `
                <a href="/messages?user=${friend.id}" class="friend-chip">
                  <div class="friend-avatar">
                    ${friend.profile_image ? 
                      `<img src="${API_BASE_URL}${friend.profile_image}" alt="">` : 
                      `<i class="fas fa-user-circle"></i>`
                    }
                  </div>
                  <span class="friend-name">${friend.username}</span>
                </a>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      if (hasConversations) {
        conversationsHtml = `
          <div class="section">
            <div class="section-header">
              <h3><i class="fas fa-history"></i> Recent Chats</h3>
            </div>
            <div class="conversations-list">
              ${data.conversations.map(conv => {
                const time = new Date(conv.timestamp);
                const timeStr = time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                
                return `
                  <a href="/messages?user=${conv.user_id}" class="conversation-item">
                    <div class="conv-avatar">
                      <i class="fas fa-user-circle"></i>
                      ${conv.unread > 0 ? '<span class="unread-dot"></span>' : ''}
                    </div>
                    <div class="conv-details">
                      <div class="conv-top">
                        <span class="conv-name">${conv.username}</span>
                        <span class="conv-time">${timeStr}</span>
                      </div>
                      <div class="conv-preview">
                        ${conv.last_message.substring(0, 40)}${conv.last_message.length > 40 ? '...' : ''}
                      </div>
                    </div>
                    ${conv.unread > 0 ? `<span class="unread-badge">${conv.unread}</span>` : ''}
                  </a>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }
      
      const noContent = !hasFriends && !hasConversations ? `
        <div class="empty-state">
          <i class="fas fa-inbox"></i>
          <p>No conversations yet</p>
        </div>
      ` : '';
      
      document.getElementById('messagesContainer').innerHTML = `
        <div class="container">
          <div class="messages-panel">
            <div class="panel-header">
              <h2><i class="fas fa-envelope"></i> Messages</h2>        
            </div>
            
            <div class="search-bar">
              <form id="searchForm" onsubmit="searchMessages(event)">
                <i class="fas fa-search search-icon"></i>
                <input type="text" name="search" id="searchInput" placeholder="Search users..." value="${searchQuery}" autocomplete="off" maxlength="50">
                ${searchQuery ? `<a href="/messages" class="clear-search"><i class="fas fa-times"></i></a>` : ''}
              </form>
            </div>
            
            ${friendsHtml}
            ${conversationsHtml}
            ${noContent}
          </div>
        </div>
      `;
    }
    
    function renderSearchResults(data) {
      document.getElementById('messagesContainer').innerHTML = `
        <div class="container">
          <div class="messages-panel">
            <div class="panel-header">
              <h2><i class="fas fa-envelope"></i> Messages</h2>        
            </div>
            
            <div class="search-bar">
              <form id="searchForm" onsubmit="searchMessages(event)">
                <i class="fas fa-search search-icon"></i>
                <input type="text" name="search" id="searchInput" placeholder="Search users..." value="${data.query}" autocomplete="off" maxlength="50">
                <a href="/messages" class="clear-search"><i class="fas fa-times"></i></a>
              </form>
            </div>
            
            <div class="search-results">
              <div class="results-header">
                <span class="results-count">${data.results.length} users found</span>
              </div>
              
              ${data.results.length === 0 ? `
                <div class="empty-state">
                  <i class="fas fa-user-slash"></i>
                  <p>No users found matching "${data.query}"</p>
                </div>
              ` : `
                <div class="users-list">
                  ${data.results.map(user => `
                    <a href="/messages?user=${user.id}" class="user-item">
                      <div class="user-avatar">
                        ${user.profile_image ? 
                          `<img src="${API_BASE_URL}${user.profile_image}" alt="">` : 
                          `<i class="fas fa-user-circle"></i>`
                        }
                      </div>
                      <div class="user-details">
                        <span class="user-name">${user.username}</span>
                        ${user.is_friend ? '<span class="friend-badge">Friend</span>' : ''}
                        ${user.is_following ? '<span class="following-badge">Following</span>' : ''}
                      </div>
                      <i class="fas fa-chevron-right"></i>
                    </a>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }
    
    function renderConversation(data) {
      currentUserId = data.other_user.id;
      
      // Add special styles for fullscreen chat
      const style = document.createElement('style');
      style.innerHTML = `
        .icon-bar { display: none !important; }
        body { padding-top: 60px !important; }
      `;
      document.head.appendChild(style);
      
      document.getElementById('messagesContainer').innerHTML = `
        <div class="chat-fullscreen">
          <div class="chat-header">
            <button class="btn btn-icon" onclick="window.location.href='/messages'">
              <i class="fas fa-arrow-left"></i>
            </button>
            <div class="chat-user" onclick="window.location.href='/view-profile?id=${data.other_user.id}&from=messages'">
              <div class="chat-avatar">
                ${data.other_user.profile_image ? 
                  `<img src="${API_BASE_URL}${data.other_user.profile_image}" alt="">` : 
                  `<i class="fas fa-user-circle"></i>`
                }
              </div>
              <div class="chat-info">
                <span class="chat-name">${data.other_user.username}</span>
                ${data.other_user.is_friend ? '<span class="friend-indicator">Friend</span>' : ''}
              </div>
            </div>
            <button class="btn btn-icon" onclick="window.location.href='/view-profile?id=${data.other_user.id}&from=messages'">
              <i class="fas fa-user"></i>
            </button>
          </div>

          <div class="messages-area-full" id="chatMessages">
            ${data.messages.map(msg => `
              <div class="message ${msg.from_id == data.other_user.id ? 'received' : 'sent'}">
                <div class="message-content">
                  ${msg.message.replace(/\n/g, '<br>')}
                </div>
                <div class="message-time ${msg.from_id == data.other_user.id ? 'received-time' : 'sent-time'}">
                  ${new Date(msg.created_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                </div>
              </div>
            `).join('')}
          </div>

          <div class="chat-input-area-full">
            <form id="messageForm" onsubmit="sendMessage(event)">
              <input type="hidden" name="csrf_token" id="csrfToken">
              <input type="hidden" name="to_id" value="${data.other_user.id}">
              <input type="text" name="message" id="messageInput" placeholder="Message..." autocomplete="off" maxlength="1000" required>
              <button type="submit" class="btn btn-primary btn-send">
                <i class="fas fa-paper-plane"></i>
              </button>
            </form>
          </div>
        </div>
      `;
      
      // Scroll to bottom
      const chatMessages = document.getElementById('chatMessages');
      if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      // Get CSRF token
      getCsrfToken();
    }
    
    function startMessageRefresh() {
      if (messagesRefreshInterval) clearInterval(messagesRefreshInterval);
      messagesRefreshInterval = setInterval(() => {
        if (selectedUser) {
          loadMessages();
        }
      }, 30000);
    }
    
    async function getCsrfToken() {
      try {
        const settings = await api.get(API_ENDPOINTS.settings);
        document.getElementById('csrfToken').value = settings.csrf_token;
      } catch (error) {
        console.error('Failed to get CSRF token:', error);
      }
    }
    
    async function sendMessage(e) {
      e.preventDefault();
      
      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();
      
      if (!message) return;
      
      const formData = new FormData();
      formData.append('csrf_token', document.getElementById('csrfToken').value);
      formData.append('to_id', selectedUser);
      formData.append('message', message);
      
      try {
        await fetch(API_ENDPOINTS.messages, {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        
        messageInput.value = '';
        loadMessages(); // Reload to show new message
        
      } catch (error) {
        alert('Failed to send message: ' + error.message);
      }
    }
    
    function searchMessages(e) {
      e.preventDefault();
      const query = document.getElementById('searchInput').value.trim();
      if (query) {
        window.location.href = `/messages?search=${encodeURIComponent(query)}`;
      }
    }
    
    // Load navbar and messages
    fetch('/navbar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('navbar-placeholder').innerHTML = html;
        return loadNavbar();
      })
      .then(() => loadMessages())
      .catch(error => console.error('Error loading navbar:', error));
  </script>

  <script src="/js/script.js"></script>
</body>
</html>