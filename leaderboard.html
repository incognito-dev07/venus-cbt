<!DOCTYPE html>
<html>
<head>
  <title>Venus CBT - Leaderboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/core.css">
  <link rel="stylesheet" href="/css/component.css">
  <link rel="stylesheet" href="/css/pages.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <script src="/js/config.js"></script>
  <script src="/js/api.js"></script>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="container">
    <div class="leaderboard-panel">
      <div class="panel-header">
        <h2><i class="fas fa-trophy"></i> Leaderboard</h2>
      </div>

      <div class="leaderboard-tabs" id="leaderboardTabs"></div>

      <div id="courseFilter" style="display: none;" class="course-filter">
        <div class="custom-select-wrapper">
          <div class="custom-select" id="customCourseSelect">
            <div class="select-selected" id="selectedCourse">
              Select Course <i class="fas fa-chevron-down"></i>
            </div>
            <div class="select-items" id="selectItems"></div>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>S/N</th>
              <th>User</th>
              <th>Points</th>
              <th>Avg</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody">
            <tr>
              <td colspan="4" class="no-data empty-state"><br>
                <i class="fas fa-info-circle"></i> 
                <p>Loading...</p><br>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="pagination" class="pagination" style="margin-top: 2rem; text-align: center;"></div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let type = urlParams.get('type') || 'global';
    let course = urlParams.get('course') || 'MTH101';
    let page = parseInt(urlParams.get('page')) || 1;
    
    let courses = [];
    let totalPages = 1;
    let currentUserId = null;
    
    function renderTabs() {
      document.getElementById('leaderboardTabs').innerHTML = `
        <a href="#" onclick="changeType('global')" class="tab ${type === 'global' ? 'active' : ''}">
          <i class="fas fa-globe"></i> Global
        </a>
        <a href="#" onclick="changeType('weekly')" class="tab ${type === 'weekly' ? 'active' : ''}">
          <i class="fas fa-calendar-week"></i> Weekly
        </a>
        <a href="#" onclick="changeType('course')" class="tab ${type === 'course' ? 'active' : ''}">
          <i class="fas fa-book"></i> By Course
        </a>
      `;
    }
    
    function changeType(newType) {
      type = newType;
      page = 1;
      if (newType === 'course') {
        window.location.href = `/leaderboard?type=${newType}&course=${course}`;
      } else {
        window.location.href = `/leaderboard?type=${newType}&page=${page}`;
      }
    }
    
    function changeCourse(courseId) {
      window.location.href = `/leaderboard?type=course&course=${courseId}`;
    }
    
    function changePage(newPage) {
      window.location.href = `/leaderboard?type=${type}&page=${newPage}`;
    }
    
    async function loadLeaderboard() {
      try {
        const params = { type, page };
        if (type === 'course') {
          params.course = course;
        }
        
        const data = await api.get(API_ENDPOINTS.leaderboard, params);
        
        courses = data.courses;
        totalPages = data.total_pages;
        currentUserId = data.current_user_id;
        
        // Update tabs
        renderTabs();
        
        // Show/hide course filter
        const courseFilter = document.getElementById('courseFilter');
        if (type === 'course') {
          courseFilter.style.display = 'block';
          renderCourseSelect();
        } else {
          courseFilter.style.display = 'none';
        }
        
        // Render leaderboard
        if (data.leaderboard.length === 0) {
          document.getElementById('leaderboardBody').innerHTML = `
            <tr>
              <td colspan="4" class="no-data empty-state"><br>
                <i class="fas fa-info-circle"></i> 
                <p>No data available yet</p><br>
              </td>
            </tr>
          `;
        } else {
          let html = '';
          data.leaderboard.forEach((entry, index) => {
            const rank = (page - 1) * 50 + index + 1;
            const rankClass = rank === 1 ? 'gold' : (rank === 2 ? 'silver' : (rank === 3 ? 'bronze' : ''));
            const rowClass = entry.is_current_user ? 'current-user' : '';
            
            html += `
              <tr class="${rowClass}" onclick="window.location.href='/view-profile?id=${entry.user_id}'">
                <td class="rank">
                  <span class="rank-number ${rankClass}">#${rank}</span>
                </td>
                <td class="user-info">
                  <div class="user-avatar">
                    ${entry.profile_image ? 
                      `<img src="${API_BASE_URL}${entry.profile_image}" alt="">` : 
                      `<i class="fas fa-user-circle"></i>`
                    }
                  </div>
                  <div class="user-details">
                    <span class="username">${entry.username}</span>
                  </div>
                </td>
                <td class="points">${entry.points.toLocaleString()}</td>
                <td class="score">
                  ${entry.hide_avg && !entry.is_current_user ? 
                    `<span class="hidden-score" title="User has hidden their average"><i class="fas fa-eye-slash"></i></span>` : 
                    `${entry.avg_score === 100 ? '100%' : entry.avg_score.toFixed(1) + '%'}`
                  }
                </td>
              </tr>
            `;
          });
          document.getElementById('leaderboardBody').innerHTML = html;
        }
        
        // Render pagination
        renderPagination();
        
      } catch (error) {
        document.getElementById('leaderboardBody').innerHTML = `
          <tr>
            <td colspan="4" class="no-data empty-state"><br>
              <i class="fas fa-exclamation-circle"></i> 
              <p>Error loading leaderboard</p><br>
            </td>
          </tr>
        `;
      }
    }
    
    function renderCourseSelect() {
      const selected = document.getElementById('selectedCourse');
      const items = document.getElementById('selectItems');
      
      const selectedCourse = courses.find(c => c.id === course);
      if (selectedCourse) {
        selected.innerHTML = `${selectedCourse.name} <i class="fas fa-chevron-down"></i>`;
      }
      
      items.innerHTML = courses.map(c => `
        <div class="select-item ${course === c.id ? 'same-as-selected' : ''}" data-value="${c.id}">
          <span class="course-code">${c.id}</span>
          <span class="course-name">${c.name}</span>
        </div>
      `).join('');
      
      // Add click handlers
      document.querySelectorAll('.select-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.stopPropagation();
          const value = this.dataset.value;
          const courseName = this.querySelector('.course-name').textContent;
          selected.innerHTML = `${courseName} <i class="fas fa-chevron-down"></i>`;
          
          document.querySelectorAll('.select-item').forEach(i => i.classList.remove('same-as-selected'));
          this.classList.add('same-as-selected');
          
          document.getElementById('customCourseSelect').classList.remove('active');
          changeCourse(value);
        });
      });
      
      // Toggle dropdown
      selected.addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('customCourseSelect').classList.toggle('active');
      });
      
      // Close on outside click
      document.addEventListener('click', function(e) {
        const select = document.getElementById('customCourseSelect');
        if (!select.contains(e.target)) {
          select.classList.remove('active');
        }
      });
    }
    
    function renderPagination() {
      if (type !== 'global' || totalPages <= 1) {
        document.getElementById('pagination').innerHTML = '';
        return;
      }
      
      let html = '';
      const maxPages = Math.min(totalPages, 10);
      
      for (let i = 1; i <= maxPages; i++) {
        html += `<a href="#" onclick="changePage(${i})" class="btn btn-small ${i === page ? 'btn-primary' : ''}" style="margin: 0 0.25rem;">${i}</a>`;
      }
      
      if (totalPages > 10) {
        html += `<span>...</span>`;
        html += `<a href="#" onclick="changePage(${totalPages})" class="btn btn-small">${totalPages}</a>`;
      }
      
      document.getElementById('pagination').innerHTML = html;
    }
    
    // Load navbar and leaderboard
    fetch('/navbar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('navbar-placeholder').innerHTML = html;
        return loadNavbar();
      })
      .then(() => loadLeaderboard())
      .catch(error => console.error('Error loading navbar:', error));
  </script>

  <script src="/js/script.js"></script>
</body>
</html>