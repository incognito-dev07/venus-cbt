<!DOCTYPE html>
<html>
<head>
  <title>Venus CBT - Profile</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="/css/core.css">
  <link rel="stylesheet" href="/css/component.css">
  <link rel="stylesheet" href="/css/pages.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <script src="/js/config.js"></script>
  <script src="/js/api.js"></script>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="container">
    <div class="profile-box">
      <h2><i class="fas fa-user-circle"></i> My Profile</h2>
      
      <div id="message" class="success" style="display: none;"></div>
      <div id="error" class="error" style="display: none;"></div>
      
      <div class="profile-image-container">
        <div class="profile-image-wrapper">
          <div id="profileImageContainer"></div>
          
          <form id="imageUploadForm" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" id="csrfToken">
            <input type="file" name="profile_image" id="profileImageInput" accept="image/*" style="display: none;">
            <button type="button" class="image-upload-btn" onclick="document.getElementById('profileImageInput').click();">
              <i class="fas fa-camera"></i>
            </button>
          </form>
        </div>
        <div class="profile-username">
          <h3 id="username"></h3>
        </div>
        
        <div class="profile-stats" id="profileStats"></div>
      </div>
      
      <div class="info-card bio">
        <div class="info-item">
          <div class="info-header">
            <i class="fas fa-quote-left"></i>
            <span class="info-label">Bio</span>
          </div>
          <span class="info-value" id="bio"></span>
        </div>
        
        <div class="info-item">
          <div class="info-header">
            <i class="fas fa-calendar-alt"></i>
            <span class="info-label">Joined:</span>
            <span class="info-value-short" id="joined"></span>
          </div>
        </div>
        
        <div id="googleInfo" style="display: none;" class="info-item">
          <div class="info-header">
            <i class="fab fa-google"></i>
            <span class="info-label">Connected with Google</span>
          </div>
        </div>
      </div>
      
      <button class="btn btn-primary btn-block edit-bio-btn" onclick="toggleBioForm()">
        <i class="fas fa-edit"></i> Edit Bio
      </button>
      
      <div class="upload-form" id="bioForm" style="display: none;">
        <h3><i class="fas fa-edit"></i> Update Bio</h3>
        <form id="bioFormSubmit">
          <input type="hidden" name="csrf_token" id="bioCsrfToken">
          <div class="form-group">
            <textarea id="bioText" rows="3" placeholder="Write something about yourself..." maxlength="500"></textarea>
          </div>
          <button type="submit" class="btn btn-primary btn-block" style="margin-bottom: 0.7rem;">
            <i class="fas fa-save"></i> Save Bio
          </button>
          <button type="button" class="btn btn-danger btn-block" onclick="toggleBioForm()">
            <i class="fas fa-arrow-left"></i> Back
          </button>
        </form>
      </div>

      <div class="stats-section" id="statsSection"></div>
      <div class="achievements-section" id="achievementsSection"></div>
            
      <div class="btn-group">
        <a href="/leaderboard" class="btn btn-primary"><i class="fas fa-trophy"></i> Leaderboard</a>
        <a href="/" class="btn btn-primary"><i class="fas fa-home"></i> Home</a>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    
    async function loadProfile() {
      try {
        const data = await api.get(API_ENDPOINTS.profile);
        currentUser = data.user;
        
        // Display profile image
        const container = document.getElementById('profileImageContainer');
        if (data.user.profile_image && data.user.profile_image !== 'null' && data.user.profile_image !== '') {
          container.innerHTML = `<img src="${API_BASE_URL}${data.user.profile_image}" alt="Profile" class="profile-image" id="profileImage">`;
        } else {
          container.innerHTML = `<div class="default-avatar" id="profileImage"><i class="fas fa-user-circle"></i></div>`;
        }
        
        document.getElementById('username').textContent = data.user.username;
        document.getElementById('bio').textContent = data.user.bio || 'No bio yet';
        document.getElementById('joined').textContent = new Date(data.user.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        
        if (data.is_google_user) {
          document.getElementById('googleInfo').style.display = 'block';
        }
        
        document.getElementById('profileStats').innerHTML = `
          <span><i class="fas fa-users"></i> ${data.followers_count} followers</span>
          <span class="stat-divider">•</span>
          <span><i class="fas fa-level-up-alt"></i> Level ${data.stats.level}</span>
          ${data.stats.streak > 0 ? `
            <span class="stat-divider">•</span>
            <span><i class="fas fa-fire"></i> ${data.stats.streak} day streak</span>
          ` : ''}
        `;
        
        document.getElementById('statsSection').innerHTML = `
          <h3><i class="fas fa-chart-bar"></i> Statistics</h3>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon"><i class="fas fa-pencil-alt"></i></div>
              <div class="stat-content">
                <span class="stat-value">${data.stats.total_tests}</span>
                <span class="stat-label">Tests Taken</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fas fa-percent"></i></div>
              <div class="stat-content">
                <span class="stat-value">${data.stats.avg_score}%</span>
                <span class="stat-label">Average Score</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fas fa-star"></i></div>
              <div class="stat-content">
                <span class="stat-value">${data.stats.best_course}</span>
                <span class="stat-label">Best Course</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon"><i class="fas fa-trophy"></i></div>
              <div class="stat-content">
                <span class="stat-value">#${data.stats.global_rank || 'N/A'}</span>
                <span class="stat-label">Global Rank</span>
              </div>
            </div>
          </div>
        `;
        
        // Load achievements
        const achievements = [];
        if (data.stats.total_tests >= 1) achievements.push({ icon: 'fa-star', name: 'First Test', desc: 'Completed your first test' });
        if (data.stats.total_tests >= 5) achievements.push({ icon: 'fa-fire', name: 'On Fire', desc: 'Completed 5 tests' });
        if (data.stats.total_tests >= 10) achievements.push({ icon: 'fa-dragon', name: 'Test Master', desc: 'Completed 10 tests' });
        if (data.stats.best_score >= 90) achievements.push({ icon: 'fa-brain', name: 'Genius', desc: 'Scored 90%+ on a test' });
        if (data.stats.avg_score >= 80) achievements.push({ icon: 'fa-graduation-cap', name: 'Scholar', desc: 'Average score 80%+' });
        
        if (achievements.length > 0) {
          document.getElementById('achievementsSection').innerHTML = `
            <h3><i class="fas fa-medal"></i> Achievements</h3>
            <div class="achievements-grid">
              ${achievements.map(a => `
                <div class="achievement-card earned">
                  <div class="achievement-header">
                    <i class="fas ${a.icon}"></i>
                    <h4>${a.name}</h4>
                  </div>
                  <p>${a.desc}</p>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          document.getElementById('achievementsSection').innerHTML = `
            <h3><i class="fas fa-medal"></i> Achievements</h3>
            <div class="no-achievements">
              <i class="fas fa-medal"></i>
              <p>Complete tests to earn achievements!</p><br>
              <a href="/select-test" class="btn btn-primary btn-small">Start a Test</a>
            </div>
          `;
        }
        
      } catch (error) {
        showError(error.message);
      }
    }
    
    function toggleBioForm() {
      const form = document.getElementById('bioForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      if (form.style.display === 'block' && currentUser) {
        document.getElementById('bioText').value = currentUser.bio || '';
      }
    }
    
    function showMessage(msg) {
      const msgDiv = document.getElementById('message');
      msgDiv.style.display = 'block';
      msgDiv.innerHTML = '<i class="fas fa-check-circle"></i> ' + msg;
      setTimeout(() => {
        msgDiv.style.display = 'none';
      }, 3000);
    }
    
    function showError(err) {
      const errDiv = document.getElementById('error');
      errDiv.style.display = 'block';
      errDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + err;
      setTimeout(() => {
        errDiv.style.display = 'none';
      }, 3000);
    }
    
    // Event listeners
    document.getElementById('profileImageInput').addEventListener('change', async function(e) {
      if (this.files && this.files[0]) {
        if (this.files[0].size > 5 * 1024 * 1024) {
          showError('Image size must be less than 5MB!');
          this.value = '';
          return;
        }
        
        if (!this.files[0].type.match('image.*')) {
          showError('Only image files are allowed!');
          this.value = '';
          return;
        }
        
        const formData = new FormData();
        formData.append('profile_image', this.files[0]);
        formData.append('csrf_token', document.getElementById('csrfToken').value);
        
        try {
          const result = await api.postForm(API_ENDPOINTS.upload, formData);
          if (result.success) {
            document.getElementById('profileImageContainer').innerHTML = `<img src="${result.image_url}" alt="Profile" class="profile-image" id="profileImage">`;
            showMessage('Profile image updated successfully!');
          }
        } catch (error) {
          showError(error.message);
        }
      }
    });
    
    document.getElementById('bioFormSubmit').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData();
      formData.append('update_bio', '1');
      formData.append('bio', document.getElementById('bioText').value);
      formData.append('csrf_token', document.getElementById('bioCsrfToken').value);
      
      try {
        const result = await api.postForm(API_ENDPOINTS.profile, formData);
        if (result.success) {
          document.getElementById('bio').textContent = document.getElementById('bioText').value;
          toggleBioForm();
          showMessage('Bio updated successfully!');
        }
      } catch (error) {
        showError(error.message);
      }
    });
    
    // Load navbar and profile
    fetch('/navbar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('navbar-placeholder').innerHTML = html;
        return loadNavbar();
      })
      .then(() => loadProfile())
      .catch(error => console.error('Error loading navbar:', error));
  </script>
  
  <script src="/js/script.js"></script>
</body>
</html>