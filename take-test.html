<!DOCTYPE html>
<html>
<head>
  <title>Venus CBT - Taking Test</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/core.css">
  <link rel="stylesheet" href="/css/component.css">
  <link rel="stylesheet" href="/css/pages.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <script src="/js/config.js"></script>
  <script src="/js/api.js"></script>
  
  <style>
    .icon-bar {
      display: none !important;
    }
    body {
      padding-top: 60px !important;
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="test-container">
    <div class="timer-bar">
      <button class="exit-test-btn" onclick="confirmExit()">
        <i class="fas fa-arrow-left"></i> Exit
      </button>
      <div class="timer-info">
        <i class="fas fa-clock"></i>
        <span id="timer">00:00</span>
      </div>
    </div>

    <div class="test-main">
      <div class="question-area">
        <div class="question-card">
          <div class="question-header">
            <span class="question-number" id="questionNumber"></span>
            <h3 id="questionText"></h3>
          </div>
          
          <div class="options-grid" id="optionsGrid"></div>

          <div class="navigation-buttons">
            <button class="nav-btn prev-btn" onclick="navigate(-1)" id="prevBtn" disabled>
              <i class="fas fa-arrow-left"></i>
              <span>Previous</span>
            </button>
            
            <button class="nav-btn next-btn" onclick="navigate(1)" id="nextBtn">
              <span>Next</span>
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>

          <div class="flag-container">
            <button class="flag-btn" onclick="flagQuestion()" id="flagBtn">
              <i class="fas fa-flag"></i>
              <span>Flag for Review</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="question-navigator-bottom">
      <div class="navigator-header">
        <h4>Question Navigator</h4>
        <div class="legend-compact">
          <span class="legend-item"><span class="dot current"></span> Current</span>
          <span class="legend-item"><span class="dot answered"></span> Answered</span>
          <span class="legend-item"><span class="dot flagged"></span> Flagged</span>
          <span class="legend-item"><span class="dot"></span> Unanswered</span>
        </div>
      </div>
      <div class="navigator-grid-bottom" id="navigator"></div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('course');
    
    let testData = null;
    let timeRemaining = 0;
    let timerInterval = null;
    
    async function loadTest() {
      if (!courseId) {
        window.location.href = '/select-test';
        return;
      }
      
      try {
        const data = await api.get(API_ENDPOINTS.takeTest, { course: courseId });
        testData = data.test;
        timeRemaining = testData.time_remaining;
        
        document.title = `Venus CBT - Taking Test: ${data.course.id}`;
        
        startTimer();
        renderQuestion();
        renderNavigator();
        
      } catch (error) {
        alert('Failed to load test: ' + error.message);
        window.location.href = '/select-test';
      }
    }
    
    function startTimer() {
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        timeRemaining--;
        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          window.location.href = '/submit-test';
          return;
        }
        updateTimerDisplay();
      }, 1000);
    }
    
    function updateTimerDisplay() {
      const minutes = Math.floor(timeRemaining / 60);
      const seconds = timeRemaining % 60;
      document.getElementById('timer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function renderQuestion() {
      const current = testData.current;
      const question = testData.question;
      
      document.getElementById('questionNumber').textContent = `${current + 1}.`;
      document.getElementById('questionText').textContent = question.question;
      
      // Render options
      let optionsHtml = '';
      question.options.forEach((option, index) => {
        const isSelected = testData.answers[current] === index;
        optionsHtml += `
          <div class="option-card ${isSelected ? 'selected' : ''}" onclick="selectOption(${index})">
            <div class="option-letter">${String.fromCharCode(65 + index)}</div>
            <div class="option-text">${option}</div>
          </div>
        `;
      });
      document.getElementById('optionsGrid').innerHTML = optionsHtml;
      
      // Update flag button
      const flagBtn = document.getElementById('flagBtn');
      if (testData.flagged[current]) {
        flagBtn.classList.add('flagged');
        flagBtn.innerHTML = '<i class="fas fa-flag"></i> <span>Flagged</span>';
      } else {
        flagBtn.classList.remove('flagged');
        flagBtn.innerHTML = '<i class="fas fa-flag"></i> <span>Flag for Review</span>';
      }
      
      // Update navigation buttons
      document.getElementById('prevBtn').disabled = current === 0;
      
      const nextBtn = document.getElementById('nextBtn');
      if (current === testData.total_questions - 1) {
        nextBtn.innerHTML = '<span>Submit</span> <i class="fas fa-check"></i>';
        nextBtn.classList.add('submit-btn');
        nextBtn.onclick = submitTest;
      } else {
        nextBtn.innerHTML = '<span>Next</span> <i class="fas fa-arrow-right"></i>';
        nextBtn.classList.remove('submit-btn');
        nextBtn.onclick = () => navigate(1);
      }
    }
    
    function renderNavigator() {
      let html = '';
      for (let i = 0; i < testData.total_questions; i++) {
        let status = '';
        if (testData.answers[i] !== null) status = 'answered';
        if (testData.flagged[i]) status = 'flagged';
        if (i === testData.current) status = 'current';
        
        html += `<div class="nav-item-bottom ${status}" onclick="goToQuestion(${i})">${i + 1}</div>`;
      }
      document.getElementById('navigator').innerHTML = html;
    }
    
    async function selectOption(optionIndex) {
      const formData = new FormData();
      formData.append('action', 'answer');
      formData.append('question', testData.current);
      formData.append('option', optionIndex);
      
      await fetch(API_ENDPOINTS.testActions, {
        method: 'POST',
        body: formData,
        credentials: 'include'
      });
      
      testData.answers[testData.current] = optionIndex;
      renderQuestion();
      renderNavigator();
    }
    
    async function flagQuestion() {
      const formData = new FormData();
      formData.append('action', 'flag');
      formData.append('question', testData.current);
      
      await fetch(API_ENDPOINTS.testActions, {
        method: 'POST',
        body: formData,
        credentials: 'include'
      });
      
      testData.flagged[testData.current] = !testData.flagged[testData.current];
      renderQuestion();
      renderNavigator();
    }
    
    async function navigate(direction) {
      const formData = new FormData();
      formData.append('action', 'navigate');
      formData.append('direction', direction);
      
      await fetch(API_ENDPOINTS.testActions, {
        method: 'POST',
        body: formData,
        credentials: 'include'
      });
      
      // Reload test data
      const data = await api.get(API_ENDPOINTS.takeTest, { course: courseId });
      testData = data.test;
      timeRemaining = testData.time_remaining;
      
      renderQuestion();
      renderNavigator();
    }
    
    async function goToQuestion(index) {
      const formData = new FormData();
      formData.append('action', 'goTo');
      formData.append('index', index);
      
      await fetch(API_ENDPOINTS.testActions, {
        method: 'POST',
        body: formData,
        credentials: 'include'
      });
      
      // Reload test data
      const data = await api.get(API_ENDPOINTS.takeTest, { course: courseId });
      testData = data.test;
      
      renderQuestion();
      renderNavigator();
    }
    
    function submitTest() {
      if (confirm('Are you sure you want to submit your test?')) {
        window.location.href = '/submit-test';
      }
    }
    
    async function confirmExit() {
      if (confirm('Are you sure you want to exit this test? Your progress will be lost.')) {
        const formData = new FormData();
        formData.append('action', 'clear_test');
        
        await fetch(API_ENDPOINTS.testActions, {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        
        window.location.href = '/select-test';
      }
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.key >= '1' && e.key <= '4') {
        e.preventDefault();
        const option = parseInt(e.key) - 1;
        if (document.querySelectorAll('.option-card')[option]) {
          selectOption(option);
        }
      }
      
      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        const prevBtn = document.getElementById('prevBtn');
        if (!prevBtn.disabled) prevBtn.click();
      }
      
      if (e.key === 'ArrowRight') {
        e.preventDefault();
        document.getElementById('nextBtn').click();
      }
      
      if (e.key.toLowerCase() === 'f') {
        e.preventDefault();
        flagQuestion();
      }
      
      if (e.key === 'Escape') {
        e.preventDefault();
        confirmExit();
      }
    });
    
    // Load navbar and test
    fetch('/navbar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('navbar-placeholder').innerHTML = html;
        return loadNavbar();
      })
      .then(() => loadTest())
      .catch(error => console.error('Error loading navbar:', error));
  </script>

  <script src="/js/script.js"></script>
</body>
</html>